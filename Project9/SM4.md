##**代码运行说明：实现过程见SM4.py**

# 一、SM4概述

SM4是一种**分组密码算法**，其**分组长度为128位**（即**16字节**，**4字**），**密钥长度也为128位**（即**16字节**，**4字**）。其加解密过程采用了**32轮**迭代机制（与DES、AES类似），每一轮需要一个轮密钥（与DES、AES类似）。

# 二、SM4的加密过程

###加密过程概述：

SM4的分组长度为4字，因此，其输入是4字的明文 （$X_{0}$,$X_{1}$,$X_{2}$,$X_{3}$）（其中$X_{i}$表示一个32位的字），经过加密后，得到的输出是4字的密文 （$Y_{0}$,$Y_{1}$,$Y_{2}$,$Y_{3}$）（其中 $Y_{i}$表示一个32位的字）。

这个加密过程分为两步，由32次轮迭代和1次反序变换组成。
####**32次轮迭代：**
首先，我们需要对这个4字明文进行32次轮迭代。每一轮轮迭代都需要一个1字的轮密钥，总共需要32个轮密钥，记为 （$rk_{0}$,$rk_{1}$,$rk_{2}$,$rk_{3}$）（其中轮密钥 $rk_{i}$在第 $i-1$轮（这里从0开始算）迭代使用，长为1字）。
迭代的过程就是不断地使用轮函数 $F$ ，往后计算下一个字。
####**一次反序变换：**
加密过程的第二步是一次简单的反序变换。将迭代最后得到的四个字 （$X_{32}$,$X_{33}$,$X_{34}$,$X_{35}$）进行反序，得到最终的密文 （$Y_{0}$,$Y_{1}$,$Y_{2}$,$Y_{3}$）=（$X_{35}$,$X_{34}$,$X_{33}$,$X_{32}$）

# 三、SM4的解密过程

SM4的解密过程与加密过程完全相同，也包括32轮迭代和一次反序变换。只是在轮迭代的时候，需要将轮密钥逆序使用。比如对 （$rk_{31}$,$rk_{30}$,...,$rk_{1}$,$rk_{0}$），第一轮使用  $rk_{31}$,，第二轮使用 $rk_{30}$，以此类推。

# 四、密钥扩展算法
原始4字加密密钥为 $MK$=（$MK_{0}$,$MK_{1}$,$MK_{2}$,$MK_{3}$）（其中$MK_{i}$为1字）。

**1、与系统参数异或——初始化密钥：**
首先需要让原始密钥的每个字 $MK_{i}$与系统参数 $FK_{i}$异或，得到4个新的字 （$K_{0}$,$K_{1}$,$K_{2}$,$K_{3}$），即 （$K_{0}$,$K_{1}$,$K_{2}$,$K_{3}$）= （$MK_{0}\bigoplus FK_{0}$,$MK_{1}\bigoplus FK_{1}$，$MK_{2}\bigoplus FK_{2}$，$MK_{3}\bigoplus FK_{3}$）

这里系统参数的取值为
![222.png](https://img1.imgtp.com/2023/08/03/CWyPvdtM.png)

**2、轮迭代生成轮密钥：**
（1）迭代方法：
在对密钥进行初始化后，我们得到了4个新的字 （$K_{0}$,$K_{1}$,$K_{2}$,$K_{3}$）。
之后，与加密过程类似，需要对这四个字进行32轮迭代，生成32个轮密钥。

第一轮迭代为：
根据前面的4个字 （$K_{0}$,$K_{1}$,$K_{2}$,$K_{3}$），计算出第5个字 $K_{4}$的值，并且将  $K_{4}$作为第一轮的轮密钥 $rk_{0}$，计算方法如下：
![333.png](https://img1.imgtp.com/2023/08/03/okVAxsmV.png)
根据 （$K_{0}$,$K_{1}$,$K_{2}$,$K_{3}$），计算出第6个字  $K_{5}$的值，并且将$K_{5}$作为第二轮的轮密钥 $rk_{1}$，计算方法如下：
![444.png](https://img1.imgtp.com/2023/08/03/eRPO710U.png)
以此类推，一直进行32轮，直到得到32个轮密钥。这32个轮密钥就是密钥扩展算法的结果。
（2）置换
线性变换 $L^{'}$如下：
![555.png](https://img1.imgtp.com/2023/08/03/BcJWBPK2.png)
（3）固定参数$CK_{i}$的取值：
32个$CK_{i}$(i∈[0,31]) 的具体值为:
![666.png](https://img1.imgtp.com/2023/08/03/YQxvfPFp.png)

# 五、测试结果

![111.png](https://img1.imgtp.com/2023/08/03/d4BcMbEc.png)

# 六、参考文献

https://zhuanlan.zhihu.com/p/363900323

